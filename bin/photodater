#!/usr/bin/env node

var fs = require('fs');
var path = require('path');
var deasync = require('deasync');
var ExifImage = require('exif').ExifImage;

var homePath = process.env[(process.platform == 'win32') ? 'USERPROFILE' : 'HOME'];
var rootPath = process.argv[2] || path.join(homePath, 'Pictures');

if (!fs.existsSync(rootPath)) {
    console.log('Usage: photodater <targetFolder>\nRearranges *.JPG into YYYY-MM-DD folders');
    return;
}

var getFileDateAsync = function (filePath, callback) {
    new ExifImage({ image: filePath }, function (err, data) {
        var date = data && data.exif && data.exif.CreateDate;
        if (date) {
            date = date.replace(':', '-').replace(':', '-');
        }
        callback(err, new Date(date));
    });
};

var getFileDate = deasync(getFileDateAsync);

var pad = function (val) {
    if (val < 10) {
        return '0' + val;
    }
    return val;
};

fs.readdirSync(rootPath).filter(function (folder) {
    return folder.indexOf('20') !== 0 && fs.lstatSync(path.join(rootPath, folder)).isDirectory();
}).forEach(function (folder) {
    var folderPath = path.join(rootPath, folder);
    var leftFiles = fs.readdirSync(folderPath).filter(function (file) {
        if (path.extname(file).toLowerCase() !== '.jpg' || !fs.lstatSync(path.join(folderPath, file)).isFile()) {
            return true;
        }
        var filePath = path.join(folderPath, file);
        var date = getFileDate(filePath);
        if (date) {
            var targetFolder = path.join(rootPath, date.getFullYear() + '-' + pad(date.getMonth() + 1) + '-' +
                pad(date.getDate()));
            if (!fs.existsSync(targetFolder)) {
                fs.mkdirSync(targetFolder);
            }
            fs.renameSync(filePath, path.join(targetFolder, file));
            return true;
        }
        return false;
    });
    if (leftFiles.length === 0) {
        fs.rmdirSync(folderPath);
    }
});